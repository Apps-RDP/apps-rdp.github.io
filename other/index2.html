<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
	</head>
	<body>
		<video id="my" style="width:150px;" muted autoplay></video>
		<video id="other" style="width:150px;display:none;" autoplay></video>
		<script type="text/javascript">
			var my=document.getElementById("my");
			var other=document.getElementById("other");
			var id="asjfy726e76agsjdfg276eahdf";
			var pc;
			function connect(){
				var socket=new WebSocket("wss://ws.achex.ca");
				pc=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});
				pc.onicecandidate=function(ev){
					if(ev.candidate){
						socket.send(JSON.stringify({to:id,command:"candidate2",msg:ev.candidate.toJSON()}));
					}
				};
				pc.ontrack=function(track){
					if(track.streams && track.streams[0]){
						other.srcObject=track.streams[0];
					}
				}
				pc.onconnectionstatechange=function(){
					console.log(pc.connectionState);
				};
				socket.onopen=async function(){
					socket.send(JSON.stringify({setID:id,passwd:"asdfhjhj2827384askdjf"}));
					var stream=await navigator.mediaDevices.getUserMedia({audio:true,video:true});
					my.srcObject=stream;
					stream.getTracks().forEach(track=>pc.addTrack(track,stream));
				};
				socket.onmessage=async function(m){
					m=m.data;
					m=JSON.parse(m);
					var c=m.command;
					var msg=m.msg;
					if(c=="candidate1"){
						pc.addIceCandidate(new RTCIceCandidate(msg));
					}
					else if(c=="offer"){
						await pc.setRemoteDescription(new RTCSessionDescription(msg));
						var answer=await pc.createAnswer();
						pc.setLocalDescription(answer);
						socket.send(JSON.stringify({to:id,command:"answer",msg:answer.toJSON()}));
					}
				};
			}
			connect();
		</script>
	</body>
</html>

